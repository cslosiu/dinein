<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<meta name="viewport" content="width=device-width, initial-scale=1"">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>

</head>

<body class="container">
 
<h1>Menu list</h1>


<div id="summary">
	üçΩÔ∏è <span id="itemcount">0</span> | 
	üçΩÔ∏è <span id="totalamount">$0.00</span>
</div>

<hr/>
<div id="catelist" >
<ul id='cateul' class="list-group list-group-horizontal">
</ul>
</div>

<hr/>
<div id="itemlist">
</div>

 

<script type='module'>
// Initialize Firestore through Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"
import { collection, getDocs, getFirestore } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"

// config
const fireconfig = {
	apiKey: 'AIzaSyAk-E1Asdy3cKqYvKGQJq2BapaYuZ1sZnk',
	authDomain: '',
	projectId: 'okra-menu'
};

const appconfig = {
	shopId: "8LMDUiQYUvVGZxfaK1eQ",
	locale: "en",
	currency: "HKD"
}
//=============================================================

function _(obj,field) 
{
	const fieldname = `${field}_${appconfig.locale}`;
	return obj[fieldname];
}

function ccy(num = 0) 
{
	return num.toLocaleString('en-US', { style: 'currency', currency: appconfig.currency });
}

function anchor(href,text) 
{
	return `<a class="btn btn-light" href="${href}">${text}</a>`;
}

function cateitem(text)
{
	return `<li class="list-group-item">${text}</li>`;
}

function buyitem(id)
{
	console.log(`buying ${id}`);
}

function itemdetail(item)
{
	const name = _(item.data(),"name");
	const price = ccy(item.data().price);
	const btn = `<button class="btn btn-primary" onclick="buyitem('${item.id}')">+</button>`;
	return `<li class="list-group-item">
		<div class="container">
			<div class="row justify-content-md-center">
				<div class="col col-md-auto">${name}</div>
				<div class="col col-md-auto text-end">${price}</div>\
				<div class="col col-md-auto text-end">${btn}</div>
			</div>
		</div>
	</li>`;
}

function settotalamount(amt)
{
	$("#totalamount").val(ccy(amt));
}

function itemgroup(category)
{
	return `<div class="card mb-3">
	  <div class="card-header">
		${category}
	  </div>
	  <ul class="list-group list-group-flush">
	  </ul>
	</div>`;
}

//=============================================================

settotalamount(0);

const firebaseApp = initializeApp(fireconfig);

const db = getFirestore();
const querySnapshot = await getDocs(collection(db, `menu/${appconfig.shopId}/category/`));
const cateul = $('#cateul');
var catarray = [];

// populate category names
querySnapshot.forEach((doc) => {
	const n = _(doc.data(), "name");
	const item = $(cateitem(n));
	cateul.append(item);
	catarray.push(doc);
	//const k = doc.id;
});


// populate all items under each category
catarray.forEach((cat) => {
	const catname = _(cat.data(), "name");
	const itemgroupnode = $(itemgroup(catname));
	const ul = itemgroupnode.find("ul");
	getDocs(collection(db, `menu/${appconfig.shopId}/category/${cat.id}/item/`))
		.then(snapshot => {
			snapshot.forEach((item) => {
				const itemnode = $(itemdetail(item));
				ul.append(itemnode);
			});
		})
		.catch(error => {
		  console.error('Error getting documents: ', error);
		  //throw error; // Re-throw error for further handling if needed
		});
	
	$('#itemlist').append(itemgroupnode);
});

</script>

</body>
</html>
